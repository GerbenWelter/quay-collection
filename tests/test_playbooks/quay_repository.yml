---
- name: Testing the quay_repository module
  hosts: localhost
  become: false
  gather_facts: false
  vars:
    quay_url: http://localhost:8080
    token: 7W4OnD9yKfqNNnKM3BTuKAut4c4cRiyLGp2YR60V

  tasks:
    # Supporting organization
    - name: Ensure organization ansibletestorg exists
      herve4m.quay.quay_organization:
        name: ansibletestorg
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    # Supporting user accounts
    - name: Ensure user accounts exist
      herve4m.quay.quay_user:
        username: "{{ item }}"
        email: "{{ item }}@example.com"
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false
      loop:
        - ansibletestuser1
        - ansibletestuser2
        - ansibletestuser3
        - ansibletestuser4
        - ansibletestuser5
        - ansibletestuser6

    # Supporting team
    - name: Ensure teams exist
      herve4m.quay.quay_team:
        name: "{{ item }}"
        organization: ansibletestorg
        role: admin
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false
      loop:
        - ansibletestteam1
        - ansibletestteam2

    - name: Ensure repository ansibletestrepo1 exists
      herve4m.quay.quay_repository:
        name: ansibletestrepo1
        namespace: ansibletestorg
        visibility: private
        description: |
          # My first repository

          * être ou ne pas être
          * Testovací úložiště
        perms:
          - name: ansibletestuser1
            type: user
            role: write
          - name: ansibletestteam1
            type: team
            role: admin
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    - name: Ensure repository ansibletestrepo1 is updated (no change)
      herve4m.quay.quay_repository:
        name: ansibletestrepo1
        namespace: ansibletestorg
        visibility: private
        description: |
          # My first repository

          * être ou ne pas être
          * Testovací úložiště
        perms:
          - name: ansibletestuser1
            type: user
            role: write
          - name: ansibletestteam1
            type: team
            role: admin
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    - name: Ensure repository ansibletestrepo2 exists
      herve4m.quay.quay_repository:
        name: ansibletestrepo2
        namespace: ansibletestorg
        visibility: public
        description: Test description
        perms:
          - name: ansibletestuser2
            type: user
            role: admin
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    - name: Ensure repository ansibletestrepo2 is updated
      herve4m.quay.quay_repository:
        name: ansibletestrepo2
        namespace: ansibletestorg
        visibility: public
        description: ""
        perms:
          - name: ansibletestuser3
            type: user
            role: read
        append: false
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    - name: Ensure repository ansibletestrepo3 exists (in admin)
      herve4m.quay.quay_repository:
        name: ansibletestrepo2
        namespace: admin
        visibility: public
        description: "In user namespace"
        perms:
          - name: ansibletestuser5
            type: user
            role: admin
        state: present
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    - name: Ensure repository ansibletestrepo3 is removed (in admin)
      herve4m.quay.quay_repository:
        name: ansibletestrepo2
        namespace: admin
        state: absent
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    - name: Ensure non-existing repository is deleted (no change)
      herve4m.quay.quay_repository:
        name: nonexistingrepo
        namespace: ansibletestorg
        state: absent
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false

    - name: Ensure repositories are removed
      herve4m.quay.quay_repository:
        name: "{{ item }}"
        namespace: ansibletestorg
        state: absent
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false
      loop:
        - ansibletestrepo1
        - ansibletestrepo2
        - ansibletestrepo3

    - name: Ensure the teams are removed
      herve4m.quay.quay_team:
        name: "{{ item }}"
        organization: ansibletestorg
        state: absent
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false
      loop:
        - ansibletestteam1
        - ansibletestteam2

    - name: Ensure user accounts are removed
      herve4m.quay.quay_user:
        username: "{{ item }}"
        state: absent
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false
      loop:
        - ansibletestuser1
        - ansibletestuser2
        - ansibletestuser3
        - ansibletestuser4
        - ansibletestuser5
        - ansibletestuser6

    - name: Ensure the organization is removed
      herve4m.quay.quay_organization:
        name: ansibletestorg
        state: absent
        quay_host: "{{ quay_url }}"
        quay_token: "{{ token }}"
        validate_certs: false
...
